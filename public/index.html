<!DOCTYPE html>
<html>
<head>
    <title>Expense Tracker</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        async function fetchTransactions() {
            const response = await fetch( '/api/transactions' )
            if ( !response.ok ) {
                document.getElementById('error-message').textContent = 'Error: Unable to fetch transactions.'
                return []
            }
            return response.json()
        }

        async function updateDatalists() {
            const transactions = await fetchTransactions()
            const descriptionList = document.getElementById('description-list')
            const sourceList = document.getElementById('source-list')

            // Popola le opzioni uniche per Descrizione e Sorgente
            const descriptions = [...new Set(transactions.map(t => t.description))]
            const sources = [...new Set(transactions.map(t => t.source))]

            descriptionList.innerHTML = ''
            sourceList.innerHTML = ''

            descriptions.forEach(desc => {
                const option = document.createElement('option')
                option.value = desc
                descriptionList.appendChild(option)
            })

            sources.forEach(source => {
                const option = document.createElement('option')
                option.value = source
                sourceList.appendChild(option)
            })
        }

        async function addTransaction( event ) {
            event.preventDefault()
            const formData = new FormData( event.target )
            const transaction = {
                date: formData.get( 'date' ) || null,
                description: formData.get( 'description' ),
                amount: formData.get( 'amount' ),
                source: formData.get( 'source' )
            }

            const response = await fetch( '/api/transactions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify( transaction )
            })

            if ( !response.ok ) {
                document.getElementById('error-message').textContent = 'Error: Unable to add transaction.'
                return
            }

            event.target.reset()
            displayTransactions()
            updateDatalists()
        }

        async function displayTransactions() {
            const transactions = await fetchTransactions()
            const list = document.getElementById( 'transaction-list' )
            list.innerHTML = ''

            transactions.forEach( t => {
                const item = document.createElement( 'li' )
                item.innerHTML = `<i class='fas fa-money-bill-wave'></i> ${t.date} - ${t.description}: €${t.amount} <i class='fas fa-wallet'></i> (${t.source})`
                list.appendChild( item )
            })
        }

        window.onload = () => {
            displayTransactions()
            updateDatalists()
        }
    </script>
</head>
<body>
    <h1><i class='fas fa-coins'></i> Expense Tracker</h1>
    <p id="error-message" style="color: red;"></p>
    <form id="transaction-form" onsubmit="addTransaction(event)">
        <input type="date" name="date">
        <input type="text" name="description" placeholder="Description" list="description-list" required>
        <datalist id="description-list">
            <!-- Populate dynamically -->
        </datalist>
        <input type="number" name="amount" placeholder="Amount (€)" step="0.01" required>
        <input type="text" name="source" placeholder="Source" list="source-list" required>
        <datalist id="source-list">
            <!-- Populate dynamically -->
        </datalist>
        <button type="submit"><i class='fas fa-plus-circle'></i> Add</button>
    </form>
    <ul id="transaction-list"></ul>
</body>
</html>
